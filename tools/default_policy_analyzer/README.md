# Default Policy Analyzer

Standalone tool that performs static analysis of `serverless.yml` files to extract IAM policy configurations and generate statistics. This is independent from the core PrivLess dynamic analysis pipeline and is used to compare developer-declared default policies against the usage-based policies generated by PrivLess to quantify over-privilege.

## Overview

The analyzer parses serverless configuration files to extract:
- Provider-level (global) IAM statements (`provider.iamRoleStatements`, `provider.iam.role.statements`)
- Function-level IAM statements (requires `serverless-iam-roles-per-function` plugin)
- Statement inheritance behavior (`iamRoleStatementsInherit`)

For each application it produces a detailed statistics record including per-function metrics, service usage breakdowns, wildcard analysis, and dangerous permission identification.

## How It Works

1. **YAML Parsing**: Reads `serverless.yml`/`serverless.yaml` with CloudFormation intrinsic function support.

2. **Statement Extraction**: Collects IAM statements from both provider and function levels, handling inheritance rules (functions inherit provider statements unless they define a custom `role` or set `iamRoleStatementsInherit: false`).

3. **Action Wildcard Analysis**: Classifies each IAM action into:
   - **Full wildcard** (`*`) — grants all permissions across all services
   - **Service wildcard** (`s3:*`) — grants all permissions for a service
   - **Prefix wildcard** (`s3:Get*`) — grants all permissions matching a prefix
   - **Specific** (`s3:GetObject`) — single permission

   Effective permission counts are computed using `data/iam_service_actions.json` and `data/permission_count.json` for accurate wildcard expansion.

4. **Resource Wildcard Analysis**: Classifies each resource ARN into:
   - **Full wildcard** (`*`) — all resources across all services
   - **Service wildcard** (e.g., `arn:aws:s3:::*`) — all top-level resources of a type
   - **Prefix wildcard** (e.g., `arn:aws:s3:::bucket/*`) — subset of resources

5. **Dangerous Permission Detection**: Flags `delete` and `update` actions and tracks which functions use them.

6. **Output**: Results are written as JSONL to `output/results/default_policy_analysis/default_policy_stats_<language>.jsonl`. All languages share a single flat directory (no language-specific subfolders). Supports resume capability via a per-language processing state file.

## Usage

```bash
# Analyze JavaScript serverless apps
python tools/default_policy_analyzer/privLess_default_policy_analyzer.py \
  --language javascript --apps-json apps.json

# Custom output directory with 8 parallel workers
python tools/default_policy_analyzer/privLess_default_policy_analyzer.py \
  --language python --apps-json apps.json --output-dir ./output --workers 8

# Force reprocess all apps (ignore resume state)
python tools/default_policy_analyzer/privLess_default_policy_analyzer.py \
  --language go --apps-json apps.json --force-reprocess
```

### CLI Options

| Flag | Description | Default |
|---|---|---|
| `--language` | App language (`javascript`, `typescript`, `python`, `go`, `csharp`) | Required |
| `--apps-json` | Path to JSON file listing app directories | Required |
| `--output-dir` | Output directory for results | `output/results/default_policy_analysis` |
| `--workers` | Number of concurrent workers | `4` |
| `--resume` / `--no-resume` | Resume from previous run | `--resume` |
| `--force-reprocess` | Clear state and reprocess all apps | `false` |

## Data Dependencies

- `data/permission_count.json` — Pre-computed permission counts per AWS service (for wildcard expansion)
- `data/iam_service_actions.json` — Full action details for prefix wildcard matching

Both are resolved automatically relative to the project root.
